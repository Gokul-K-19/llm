# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JNVXPegN2fS6uvZu6mUqUqHaR6oNcWVM
"""

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch

model_name = "microsoft/DialoGPT-medium"

tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(model_name)

device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)

chat_history_ids = None

chat_history_ids = None

chat_history_ids = None
MAX_HISTORY = 512

for step in range(3):
    user_input = input("User: ")
    user_input = "You are an educational chatbot. Answer clearly.\n" + user_input

    new_input_ids = tokenizer.encode(
        user_input + tokenizer.eos_token,
        return_tensors="pt"
    ).to(device)

    bot_input_ids = (
        torch.cat([chat_history_ids, new_input_ids], dim=-1)
        if chat_history_ids is not None
        else new_input_ids
    )

    if bot_input_ids.shape[-1] > MAX_HISTORY:
        bot_input_ids = bot_input_ids[:, -MAX_HISTORY:]

    attention_mask = torch.ones(bot_input_ids.shape, device=device)

    chat_history_ids = model.generate(
        bot_input_ids,
        attention_mask=attention_mask,
        max_length=256,
        num_beams=3,
        pad_token_id=tokenizer.eos_token_id
    )

    response = tokenizer.decode(
        chat_history_ids[:, bot_input_ids.shape[-1]:][0],
        skip_special_tokens=True
    )

    print("Bot:", response)


